<!DOCTYPE html>
<html>
<head>
    <title>Test Remplacement Mission</title>
</head>
<body>
    <h1>Test du remplacement automatique des missions</h1>
    <div id="status">Chargement...</div>
    <div id="logs" style="font-family:monospace; font-size:12px; margin-top:20px;"></div>
    
    <script>
        // Simuler les objets du système
        function canonicalizeLieu(lieu) {
            return (lieu || '').toUpperCase().trim()
        }
        
        function resolveDispoKind(dispo) {
            const canon = canonicalizeLieu(dispo.lieu || '')
            const originalLieu = dispo.lieu || ''
            
            if (canon === 'INDISPONIBLE') return { type: 'indisponible', timeKind: 'full-day' }
            if (canon === 'DISPO JOURNEE') return { type: 'disponible', timeKind: 'full-day' }
            
            const hasSpecificLocation = originalLieu && 
                originalLieu !== 'DISPONIBLE' && 
                originalLieu !== 'DISPO' && 
                originalLieu !== 'INDISPONIBLE' &&
                originalLieu.trim() !== ''
            
            const hasHours = !!(dispo.heure_debut && dispo.heure_fin)
            let detectedTimeKind = 'full-day'
            
            if (hasHours) {
                const startTime = parseInt(dispo.heure_debut.split(':')[0])
                const endTime = parseInt(dispo.heure_fin.split(':')[0])
                
                if (endTime < startTime) {
                    detectedTimeKind = 'overnight'
                } else {
                    detectedTimeKind = 'range'
                }
            }
            
            if (hasHours) {
                return { type: hasSpecificLocation ? 'mission' : 'disponible', timeKind: detectedTimeKind }
            }
            return { type: hasSpecificLocation ? 'mission' : 'disponible', timeKind: 'full-day' }
        }
        
        function hasTimeConflict(dispo1, dispo2) {
            const kind1 = resolveDispoKind(dispo1)
            const kind2 = resolveDispoKind(dispo2)
            
            // Si l'une des deux est full-day, il y a conflit
            if (kind1.timeKind === 'full-day' || kind2.timeKind === 'full-day') return true
            
            // Si les deux ont des horaires, vérifier le chevauchement
            if (kind1.timeKind === 'range' && kind2.timeKind === 'range') {
                const start1 = dispo1.heure_debut
                const end1 = dispo1.heure_fin
                const start2 = dispo2.heure_debut
                const end2 = dispo2.heure_fin
                
                if (start1 && end1 && start2 && end2) {
                    return start1 < end2 && start2 < end1
                }
            }
            
            return false
        }
        
        // Test du système
        function runTest() {
            const logs = []
            
            // Disponibilité existante "disponible"
            const existingDispo = {
                type: 'disponible',
                lieu: '',
                heure_debut: null,
                heure_fin: null
            }
            
            // Nouvelle mission
            const newMission = {
                type: 'mission', 
                lieu: 'Bureau',
                heure_debut: null,
                heure_fin: null
            }
            
            logs.push('=== TEST DE REMPLACEMENT ===')
            logs.push('Disponibilité existante:', JSON.stringify(existingDispo))
            logs.push('Nouvelle mission:', JSON.stringify(newMission))
            
            const existingKind = resolveDispoKind(existingDispo)
            const missionKind = resolveDispoKind(newMission)
            
            logs.push('Type existant détecté:', existingKind.type, existingKind.timeKind)
            logs.push('Type mission détecté:', missionKind.type, missionKind.timeKind)
            
            const canReplace = existingKind.type === 'disponible'
            logs.push('Peut remplacer?', canReplace)
            
            if (canReplace) {
                const hasConflict = hasTimeConflict(newMission, existingDispo)
                logs.push('Conflit horaire?', hasConflict)
                logs.push('RÉSULTAT: REMPLACEMENT', hasConflict ? 'AUTORISÉ' : 'BLOQUÉ')
            } else {
                logs.push('RÉSULTAT: REMPLACEMENT BLOQUÉ (type incompatible)')
            }
            
            document.getElementById('logs').innerHTML = logs.map(log => 
                typeof log === 'string' ? log : JSON.stringify(log)
            ).join('<br>')
            
            document.getElementById('status').textContent = 'Test terminé'
        }
        
        setTimeout(runTest, 100)
    </script>
</body>
</html>
