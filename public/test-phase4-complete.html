<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Syst√®me Multi-Utilisateur Unifi√©</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { 
            background: #2a2a2a; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #000; }
        .button.danger { background: #dc3545; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            background: #333; 
        }
        .status.success { background: #155724; border-left: 4px solid #28a745; }
        .status.error { background: #721c24; border-left: 4px solid #dc3545; }
        .status.info { background: #0c5460; border-left: 4px solid #17a2b8; }
        .user-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .user-item { 
            background: #333; 
            padding: 10px; 
            border-radius: 4px; 
            border-left: 4px solid #007bff; 
        }
        .notification-item {
            background: #444;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
        }
        pre { 
            background: #111; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto; 
            border: 1px solid #444; 
        }
        .metrics { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
        }
        .metric-card { 
            background: #333; 
            padding: 15px; 
            border-radius: 4px; 
            text-align: center; 
        }
        .metric-value { 
            font-size: 2em; 
            font-weight: bold; 
            color: #007bff; 
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #111;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Syst√®me Multi-Utilisateur Unifi√© - Phase 4</h1>
        
        <!-- Statut g√©n√©ral -->
        <div class="section">
            <h2>üìä √âtat du Syst√®me</h2>
            <div id="system-status" class="status info">
                ‚è≥ Initialisation en cours...
            </div>
            
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="connected-users">0</div>
                    <div>Utilisateurs connect√©s</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="total-sessions">0</div>
                    <div>Sessions actives</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="notification-count">0</div>
                    <div>Notifications</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="cell-activities">0</div>
                    <div>Activit√©s cellules</div>
                </div>
            </div>
        </div>

        <!-- Actions de test -->
        <div class="section">
            <h2>üéÆ Actions de Test</h2>
            <button class="button" onclick="simulateUserJoin()">üë§ Simuler arriv√©e utilisateur</button>
            <button class="button" onclick="simulateUserLeave()">üö™ Simuler d√©part utilisateur</button>
            <button class="button warning" onclick="simulateCellConflict()">‚ö†Ô∏è Simuler conflit cellule</button>
            <button class="button success" onclick="sendTestNotification()">üîî Notification test</button>
            <button class="button" onclick="lockRandomCell()">üîí Verrouiller cellule</button>
            <button class="button" onclick="unlockAllCells()">üîì D√©verrouiller tout</button>
            <button class="button danger" onclick="clearAllData()">üóëÔ∏è Vider les donn√©es</button>
        </div>

        <!-- Utilisateurs connect√©s -->
        <div class="section">
            <h2>üë• Utilisateurs Connect√©s</h2>
            <div id="users-list" class="user-list">
                <div class="status info">Aucun utilisateur connect√©</div>
            </div>
        </div>

        <!-- Notifications r√©centes -->
        <div class="section">
            <h2>üîî Notifications R√©centes</h2>
            <div id="notifications-list">
                <div class="status info">Aucune notification</div>
            </div>
        </div>

        <!-- Activit√©s cellules -->
        <div class="section">
            <h2>üì± Activit√©s Cellules</h2>
            <div id="cell-activities-list">
                <div class="status info">Aucune activit√©</div>
            </div>
        </div>

        <!-- Log en temps r√©el -->
        <div class="section">
            <h2>üìã Log Temps R√©el</h2>
            <button class="button" onclick="clearLog()">Vider le log</button>
            <div id="log-container" class="log-container"></div>
        </div>

        <!-- Donn√©es JSON brutes -->
        <div class="section">
            <h2>üîç Donn√©es Brutes (Debug)</h2>
            <button class="button" onclick="refreshDebugData()">üîÑ Actualiser</button>
            <pre id="debug-data">Cliquez sur "Actualiser" pour voir les donn√©es</pre>
        </div>
    </div>

    <script type="module">
        // Simulation des services pour le test
        let mockUsers = [];
        let mockNotifications = [];
        let mockCellActivities = [];
        let simulatedSessionId = 0;

        // Fonctions utilitaires
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : 
                                 type === 'success' ? '#28a745' : 
                                 type === 'warning' ? '#ffc107' : '#17a2b8';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateMetrics() {
            document.getElementById('connected-users').textContent = mockUsers.length;
            document.getElementById('total-sessions').textContent = 
                mockUsers.reduce((acc, user) => acc + user.sessions.length, 0);
            document.getElementById('notification-count').textContent = mockNotifications.length;
            document.getElementById('cell-activities').textContent = mockCellActivities.length;
        }

        function updateUsersList() {
            const container = document.getElementById('users-list');
            if (mockUsers.length === 0) {
                container.innerHTML = '<div class="status info">Aucun utilisateur connect√©</div>';
                return;
            }

            container.innerHTML = mockUsers.map(user => `
                <div class="user-item">
                    <strong>${user.displayName}</strong><br>
                    <small>${user.email}</small><br>
                    <span style="color: #28a745;">${user.sessions.length} session(s)</span>
                </div>
            `).join('');
        }

        function updateNotificationsList() {
            const container = document.getElementById('notifications-list');
            if (mockNotifications.length === 0) {
                container.innerHTML = '<div class="status info">Aucune notification</div>';
                return;
            }

            container.innerHTML = mockNotifications.slice(-5).reverse().map(notif => `
                <div class="notification-item">
                    <strong>${notif.title}</strong><br>
                    <small>${notif.message}</small><br>
                    <span style="color: #666;">${notif.timestamp.toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        function updateCellActivitiesList() {
            const container = document.getElementById('cell-activities-list');
            if (mockCellActivities.length === 0) {
                container.innerHTML = '<div class="status info">Aucune activit√©</div>';
                return;
            }

            container.innerHTML = mockCellActivities.slice(-5).reverse().map(activity => `
                <div class="notification-item">
                    <strong>${activity.type}</strong> - ${activity.collaborateurId}<br>
                    <small>Date: ${activity.date} par ${activity.userId}</small><br>
                    <span style="color: #666;">${activity.timestamp.toLocaleTimeString()}</span>
                </div>
            `).join('');
        }

        function updateAll() {
            updateMetrics();
            updateUsersList();
            updateNotificationsList();
            updateCellActivitiesList();
        }

        // Actions de test
        window.simulateUserJoin = function() {
            const userNames = ['Alice Martin', 'Bob Dupont', 'Charlie Durand', 'Diana Petit', 'Eve Moreau'];
            const randomName = userNames[Math.floor(Math.random() * userNames.length)];
            const newUser = {
                uid: `user-${Date.now()}`,
                displayName: randomName,
                email: `${randomName.toLowerCase().replace(' ', '.')}@example.com`,
                sessions: [{
                    sessionId: `session-${++simulatedSessionId}`,
                    status: 'online',
                    timestamp: new Date()
                }]
            };
            
            mockUsers.push(newUser);
            
            // Ajouter notification
            mockNotifications.push({
                id: `notif-${Date.now()}`,
                type: 'user-join',
                title: 'Utilisateur connect√©',
                message: `${randomName} vient de se connecter`,
                timestamp: new Date()
            });

            log(`‚úÖ ${randomName} s'est connect√©`, 'success');
            updateAll();
        };

        window.simulateUserLeave = function() {
            if (mockUsers.length === 0) {
                log('‚ùå Aucun utilisateur √† d√©connecter', 'warning');
                return;
            }

            const userIndex = Math.floor(Math.random() * mockUsers.length);
            const user = mockUsers[userIndex];
            mockUsers.splice(userIndex, 1);

            // Ajouter notification
            mockNotifications.push({
                id: `notif-${Date.now()}`,
                type: 'user-leave',
                title: 'Utilisateur d√©connect√©',
                message: `${user.displayName} s'est d√©connect√©`,
                timestamp: new Date()
            });

            log(`üëã ${user.displayName} s'est d√©connect√©`, 'info');
            updateAll();
        };

        window.simulateCellConflict = function() {
            const collaborateurs = ['C001', 'C002', 'C003', 'C004'];
            const dates = ['2024-01-15', '2024-01-16', 'C2024-01-17'];
            
            const activity = {
                type: 'conflict',
                collaborateurId: collaborateurs[Math.floor(Math.random() * collaborateurs.length)],
                date: dates[Math.floor(Math.random() * dates.length)],
                userId: mockUsers.length > 0 ? mockUsers[0].uid : 'system',
                timestamp: new Date()
            };

            mockCellActivities.push(activity);

            // Ajouter notification
            mockNotifications.push({
                id: `notif-${Date.now()}`,
                type: 'cell-conflict',
                title: 'Conflit d√©tect√©',
                message: `Conflit sur la cellule ${activity.collaborateurId} - ${activity.date}`,
                timestamp: new Date()
            });

            log(`‚ö†Ô∏è Conflit simul√© sur ${activity.collaborateurId} - ${activity.date}`, 'warning');
            updateAll();
        };

        window.sendTestNotification = function() {
            mockNotifications.push({
                id: `notif-${Date.now()}`,
                type: 'info',
                title: 'Notification test',
                message: 'Ceci est une notification de test du syst√®me',
                timestamp: new Date()
            });

            log('üîî Notification test envoy√©e', 'info');
            updateAll();
        };

        window.lockRandomCell = function() {
            const collaborateurs = ['C001', 'C002', 'C003', 'C004'];
            const dates = ['2024-01-15', '2024-01-16', '2024-01-17'];
            
            const activity = {
                type: 'lock',
                collaborateurId: collaborateurs[Math.floor(Math.random() * collaborateurs.length)],
                date: dates[Math.floor(Math.random() * dates.length)],
                userId: mockUsers.length > 0 ? mockUsers[0].uid : 'system',
                timestamp: new Date()
            };

            mockCellActivities.push(activity);
            log(`üîí Cellule verrouill√©e: ${activity.collaborateurId} - ${activity.date}`, 'warning');
            updateAll();
        };

        window.unlockAllCells = function() {
            const lockedCount = mockCellActivities.filter(a => a.type === 'lock').length;
            mockCellActivities = mockCellActivities.filter(a => a.type !== 'lock');
            log(`üîì ${lockedCount} cellule(s) d√©verrouill√©e(s)`, 'success');
            updateAll();
        };

        window.clearAllData = function() {
            if (confirm('√ätes-vous s√ªr de vouloir vider toutes les donn√©es ?')) {
                mockUsers = [];
                mockNotifications = [];
                mockCellActivities = [];
                log('üóëÔ∏è Toutes les donn√©es ont √©t√© vid√©es', 'info');
                updateAll();
            }
        };

        window.clearLog = function() {
            document.getElementById('log-container').innerHTML = '';
        };

        window.refreshDebugData = function() {
            const debugData = {
                timestamp: new Date().toISOString(),
                users: mockUsers,
                notifications: mockNotifications.slice(-3),
                cellActivities: mockCellActivities.slice(-3),
                metrics: {
                    connectedUsers: mockUsers.length,
                    totalSessions: mockUsers.reduce((acc, user) => acc + user.sessions.length, 0),
                    notificationCount: mockNotifications.length,
                    cellActivityCount: mockCellActivities.length
                }
            };

            document.getElementById('debug-data').textContent = JSON.stringify(debugData, null, 2);
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Syst√®me de test initialis√©', 'success');
            document.getElementById('system-status').innerHTML = '‚úÖ Syst√®me op√©rationnel - Test simul√©';
            document.getElementById('system-status').className = 'status success';
            
            // Ajouter quelques donn√©es de test
            setTimeout(() => {
                simulateUserJoin();
                setTimeout(() => {
                    simulateUserJoin();
                    sendTestNotification();
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>
