<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multi-Onglets - Keydispo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-box {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4ECDC4;
        }
        
        .test-section {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .sessions-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .session-card {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #555;
        }
        
        .session-card.active {
            border-color: #4ECDC4;
            background: #2a4a4a;
        }
        
        .activity-indicator {
            background: #ff6b6b;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin: 5px 0;
            display: inline-block;
        }
        
        .activity-indicator.hover {
            background: #4ECDC4;
            color: black;
        }
        
        .activity-indicator.edit {
            background: #ffa726;
            color: black;
        }
        
        .btn {
            background: #4ECDC4;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #45B7AA;
        }
        
        .btn.danger {
            background: #ff6b6b;
            color: white;
        }
        
        .log-output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .instructions {
            background: #444;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: #555;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó Test Synchronisation Multi-Onglets</h1>
        <p>Testez la synchronisation temps r√©el entre plusieurs onglets</p>
    </div>
    
    <div class="status-box">
        <h3>üìä √âtat du Syst√®me</h3>
        <div class="stats-display">
            <div class="stat-card">
                <div class="stat-value" id="session-count">0</div>
                <div>Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="user-count">0</div>
                <div>Utilisateurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activity-count">0</div>
                <div>Activit√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sync-status">‚ùå</div>
                <div>Synchronisation</div>
            </div>
        </div>
    </div>
    
    <div class="instructions">
        <h3>üìã Instructions Multi-Onglets</h3>
        <ol>
            <li><strong>Ouvrez un second onglet</strong> avec cette m√™me page</li>
            <li><strong>Initialisez</strong> le syst√®me dans les deux onglets</li>
            <li><strong>Cr√©ez des activit√©s</strong> dans un onglet</li>
            <li><strong>V√©rifiez</strong> qu'elles apparaissent dans l'autre onglet</li>
            <li><strong>Testez les survols</strong> et les verrouillages</li>
        </ol>
    </div>
    
    <div class="test-section">
        <h3>üéÆ Contr√¥les de Test</h3>
        <button class="btn" onclick="initSystem()">üöÄ Initialiser Syst√®me</button>
        <button class="btn" onclick="createTestActivity()">üì± Cr√©er Activit√© Test</button>
        <button class="btn" onclick="refreshState()">üîÑ Actualiser √âtat</button>
        <button class="btn danger" onclick="cleanup()">üßπ Nettoyer</button>
    </div>
    
    <div class="test-section">
        <h3>üë• Sessions Actives</h3>
        <div id="sessions-container" class="sessions-display">
            <div class="session-card">
                <div>Aucune session active</div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>‚ö° Activit√©s en Temps R√©el</h3>
        <div id="activities-container">
            <div>Aucune activit√© d√©tect√©e</div>
        </div>
    </div>
    
    <div class="log-output" id="log-output">üìù Logs de synchronisation...\n</div>

    <script type="module">
        // Variables globales
        let multiUserService = null;
        let migrationService = null;
        let isInitialized = false;
        let refreshInterval = null;
        
        // Configuration
        const SESSION_ID = `tab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // Fonctions utilitaires
        function log(message, type = 'info') {
            const output = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStats(stats) {
            document.getElementById('session-count').textContent = stats.sessions || 0;
            document.getElementById('user-count').textContent = stats.users || 0;
            document.getElementById('activity-count').textContent = stats.activities || 0;
            document.getElementById('sync-status').textContent = isInitialized ? '‚úÖ' : '‚ùå';
        }
        
        function displaySessions(sessions) {
            const container = document.getElementById('sessions-container');
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<div class="session-card"><div>Aucune session active</div></div>';
                return;
            }
            
            container.innerHTML = sessions.map(session => `
                <div class="session-card ${session.sessionId === SESSION_ID ? 'active' : ''}">
                    <div><strong>${session.userName || 'Utilisateur'}</strong></div>
                    <div><small>${session.sessionId}</small></div>
                    <div><small>Status: ${session.status}</small></div>
                    <div><small>Derni√®re activit√©: ${new Date(session.lastActivity?.toDate?.() || session.lastActivity || Date.now()).toLocaleTimeString()}</small></div>
                    ${session.sessionId === SESSION_ID ? '<div class="activity-indicator">CETTE SESSION</div>' : ''}
                </div>
            `).join('');
        }
        
        function displayActivities(activities) {
            const container = document.getElementById('activities-container');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div>Aucune activit√© d√©tect√©e</div>';
                return;
            }
            
            container.innerHTML = activities.map(activity => `
                <div class="activity-indicator ${activity.type}">
                    ${activity.type}: ${activity.cellId} par ${activity.userName}
                </div>
            `).join('');
        }
        
        // Fonctions principales
        async function initSystem() {
            try {
                log('üöÄ Initialisation du syst√®me multi-onglets...');
                
                // Import des services
                const { multiUserMigrationService } = await import('/src/services/multiUserMigrationService.ts');
                const { hybridMultiUserService } = await import('/src/services/hybridMultiUserService.ts');
                
                migrationService = multiUserMigrationService;
                multiUserService = hybridMultiUserService;
                
                // Utilisateur de test unique par onglet
                const testUser = {
                    uid: `user_${SESSION_ID}`,
                    displayName: `Test User ${SESSION_ID.slice(-8)}`,
                    email: `test.${SESSION_ID.slice(-8)}@keydispo.com`
                };
                
                await migrationService.init('keydispo', testUser);
                isInitialized = true;
                
                log(`‚úÖ Syst√®me initialis√© pour: ${testUser.displayName}`, 'success');
                log(`üì± Session ID: ${SESSION_ID}`);
                
                // D√©marrer le rafra√Æchissement automatique
                startAutoRefresh();
                
                // Premier rafra√Æchissement
                await refreshState();
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`, 'error');
                console.error('Erreur init:', error);
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                if (isInitialized) {
                    await refreshState();
                }
            }, 2000); // Rafra√Æchir toutes les 2 secondes
            
            log('üîÑ Rafra√Æchissement automatique d√©marr√©');
        }
        
        async function refreshState() {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©', 'warning');
                return;
            }
            
            try {
                // R√©cup√©rer l'√©tat du syst√®me
                const connectedUsers = multiUserService.getConnectedUsers();
                const activities = multiUserService.getAllActivities();
                const stats = multiUserService.getStats();
                
                // Mettre √† jour l'affichage
                updateStats({
                    sessions: connectedUsers.length,
                    users: new Set(connectedUsers.map(u => u.userId)).size,
                    activities: activities.length
                });
                
                displaySessions(connectedUsers);
                displayActivities(activities.map(a => ({
                    type: a.type,
                    cellId: a.cellId,
                    userName: a.userName || 'Unknown'
                })));
                
                log(`üîÑ √âtat actualis√©: ${connectedUsers.length} sessions, ${activities.length} activit√©s`);
                
            } catch (error) {
                log(`‚ùå Erreur rafra√Æchissement: ${error.message}`, 'error');
            }
        }
        
        async function createTestActivity() {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©', 'warning');
                return;
            }
            
            try {
                const testCollab = 'amanton-elise';
                const testDate = new Date().toISOString().split('T')[0];
                
                log(`üì± Cr√©ation activit√© test: ${testCollab}_${testDate}`);
                
                // Cr√©er une activit√© de survol
                await multiUserService.hoverCell(testCollab, testDate);
                
                log('‚úÖ Activit√© cr√©√©e avec succ√®s', 'success');
                
                // Rafra√Æchir l'√©tat
                setTimeout(refreshState, 500);
                
            } catch (error) {
                log(`‚ùå Erreur cr√©ation activit√©: ${error.message}`, 'error');
            }
        }
        
        async function cleanup() {
            try {
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                    refreshInterval = null;
                }
                
                if (migrationService) {
                    await migrationService.cleanup();
                }
                
                isInitialized = false;
                multiUserService = null;
                migrationService = null;
                
                updateStats({ sessions: 0, users: 0, activities: 0 });
                displaySessions([]);
                displayActivities([]);
                
                log('üßπ Nettoyage termin√©', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur nettoyage: ${error.message}`, 'error');
            }
        }
        
        // Exposer les fonctions globalement
        window.initSystem = initSystem;
        window.createTestActivity = createTestActivity;
        window.refreshState = refreshState;
        window.cleanup = cleanup;
        
        // Initialisation
        updateStats({ sessions: 0, users: 0, activities: 0 });
        log(`üí° Page de test multi-onglets charg√©e (Session: ${SESSION_ID.slice(-8)})`);
        log('üîó Ouvrez cette page dans un autre onglet pour tester la synchronisation');
    </script>
</body>
</html>
