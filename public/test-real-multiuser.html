<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multi-Utilisateur R√©el - Keydispo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-box {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4ECDC4;
        }
        
        .test-cell {
            display: inline-block;
            width: 120px;
            height: 40px;
            background: #333;
            border: 1px solid #555;
            margin: 5px;
            cursor: pointer;
            position: relative;
            border-radius: 4px;
            line-height: 40px;
            text-align: center;
            font-size: 12px;
        }
        
        .test-cell:hover {
            background: #444;
        }
        
        .test-cell.locked {
            background: #ff6b6b !important;
            color: white;
        }
        
        .test-cell.hovered {
            background: #4ECDC4 !important;
            color: black;
        }
        
        .cell-hover-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #4ECDC4;
            color: black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            line-height: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .cell-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 107, 107, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn {
            background: #4ECDC4;
            color: black;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #45B7AA;
        }
        
        .btn.danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn.danger:hover {
            background: #e55555;
        }
        
        .log-output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .instructions {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .instructions ol {
            margin: 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Test Multi-Utilisateur R√©el</h1>
        <p>Test du syst√®me multi-utilisateur sans fausses donn√©es</p>
    </div>
    
    <div class="status-box">
        <h3>üìä √âtat du Syst√®me</h3>
        <div>Syst√®me initialis√©: <span id="system-status">‚ùå Non</span></div>
        <div>Utilisateur connect√©: <span id="user-status">‚ùå Aucun</span></div>
        <div>Sessions actives: <span id="session-count">0</span></div>
        <div>Services charg√©s: <span id="services-status">‚ùå Non</span></div>
    </div>
    
    <div class="instructions">
        <h3>üìã Instructions</h3>
        <ol>
            <li>Ouvrez l'application principale dans un autre onglet (http://localhost:3001)</li>
            <li>Connectez-vous avec votre compte</li>
            <li>Revenez ici et cliquez sur "Initialiser le syst√®me"</li>
            <li>Survolez les cellules de test ci-dessous</li>
            <li>Observez les indicateurs multi-utilisateur (sans fausses donn√©es)</li>
        </ol>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="initSystem()">üöÄ Initialiser le Syst√®me</button>
        <button class="btn" onclick="testHover()">üëÜ Test Survol</button>
        <button class="btn" onclick="testLock()">üîí Test Verrouillage</button>
        <button class="btn danger" onclick="cleanup()">üßπ Nettoyer</button>
        <button class="btn" onclick="clearLog()">üìã Vider Log</button>
    </div>
    
    <div style="margin: 20px 0;">
        <h3>üî≤ Cellules de Test</h3>
        <div id="test-cells">
            <!-- Les cellules seront g√©n√©r√©es dynamiquement -->
        </div>
    </div>
    
    <div class="log-output" id="log-output">üìù Logs du syst√®me...\n</div>

    <script type="module">
        // Variables globales
        let multiUserService = null;
        let isInitialized = false;
        
        // Configuration
        const TEST_COLLABORATEURS = ['amanton-elise', 'alidjra-sandra', 'amoev-marine'];
        const TEST_DATE = new Date().toISOString().split('T')[0]; // Aujourd'hui
        
        // Fonctions utilitaires
        function log(message) {
            const output = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStatus() {
            document.getElementById('system-status').textContent = isInitialized ? '‚úÖ Oui' : '‚ùå Non';
            document.getElementById('user-status').textContent = isInitialized ? '‚úÖ Connect√©' : '‚ùå Aucun';
            document.getElementById('session-count').textContent = isInitialized ? '1' : '0';
            document.getElementById('services-status').textContent = multiUserService ? '‚úÖ Oui' : '‚ùå Non';
        }
        
        function generateTestCells() {
            const container = document.getElementById('test-cells');
            container.innerHTML = '';
            
            TEST_COLLABORATEURS.forEach((collab, i) => {
                const cellId = `${collab}_${TEST_DATE}`;
                const cell = document.createElement('div');
                cell.className = 'test-cell';
                cell.id = `cell-${cellId}`;
                cell.textContent = `${collab.split('-')[0]} (${TEST_DATE})`;
                cell.setAttribute('data-cell-id', cellId);
                
                // Events
                cell.addEventListener('mouseenter', () => startHover(cellId));
                cell.addEventListener('mouseleave', () => stopHover(cellId));
                cell.addEventListener('click', () => toggleLock(cellId));
                
                container.appendChild(cell);
            });
        }
        
        // Fonctions principales
        async function initSystem() {
            try {
                log('üöÄ Initialisation du syst√®me multi-utilisateur...');
                
                // Import dynamique des services
                const { multiUserMigrationService } = await import('/src/services/multiUserMigrationService.ts');
                multiUserService = multiUserMigrationService;
                
                // Utilisateur de test
                const testUser = {
                    uid: `test-real-${Date.now()}`,
                    displayName: 'Test Utilisateur R√©el',
                    email: 'test@keydispo.com'
                };
                
                await multiUserService.init('keydispo', testUser);
                isInitialized = true;
                
                log('‚úÖ Syst√®me initialis√© avec succ√®s');
                log(`üë§ Utilisateur: ${testUser.displayName} (${testUser.uid})`);
                
                updateStatus();
                generateTestCells();
                
                // Test p√©riodique pour v√©rifier l'√©tat
                setInterval(checkSystemState, 2000);
                
            } catch (error) {
                log(`‚ùå Erreur initialisation: ${error.message}`);
                console.error('Erreur init:', error);
            }
        }
        
        async function startHover(cellId) {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©');
                return;
            }
            
            try {
                await multiUserService.startHover(cellId);
                log(`üëÜ Survol d√©marr√©: ${cellId}`);
                
                // V√©rifier les utilisateurs en survol
                const hoveringUsers = multiUserService.getHoveringUsers(cellId);
                log(`üìä Utilisateurs en survol: ${hoveringUsers.length}`);
                
            } catch (error) {
                log(`‚ùå Erreur survol: ${error.message}`);
            }
        }
        
        async function stopHover(cellId) {
            if (!multiUserService || !isInitialized) return;
            
            try {
                await multiUserService.stopHover(cellId);
                log(`üëÜ Survol arr√™t√©: ${cellId}`);
                
            } catch (error) {
                log(`‚ùå Erreur arr√™t survol: ${error.message}`);
            }
        }
        
        async function toggleLock(cellId) {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©');
                return;
            }
            
            try {
                const isLocked = multiUserService.isCellLockedByOther(cellId);
                
                if (isLocked) {
                    await multiUserService.stopEdit(cellId);
                    log(`üîì Verrouillage retir√©: ${cellId}`);
                } else {
                    await multiUserService.startEdit(cellId);
                    log(`üîí Verrouillage ajout√©: ${cellId}`);
                }
                
                updateCellDisplay(cellId);
                
            } catch (error) {
                log(`‚ùå Erreur verrouillage: ${error.message}`);
            }
        }
        
        function updateCellDisplay(cellId) {
            const cell = document.getElementById(`cell-${cellId}`);
            if (!cell) return;
            
            const hoveringUsers = multiUserService.getHoveringUsers(cellId);
            const isLocked = multiUserService.isCellLockedByOther(cellId);
            
            // Reset classes
            cell.className = 'test-cell';
            
            // Remove existing indicators
            cell.querySelectorAll('.cell-hover-indicator, .cell-lock-overlay').forEach(el => el.remove());
            
            // Add hover indicator
            if (hoveringUsers.length > 0) {
                cell.classList.add('hovered');
                const indicator = document.createElement('div');
                indicator.className = 'cell-hover-indicator';
                indicator.textContent = hoveringUsers.length;
                cell.appendChild(indicator);
            }
            
            // Add lock overlay
            if (isLocked) {
                cell.classList.add('locked');
                const overlay = document.createElement('div');
                overlay.className = 'cell-lock-overlay';
                overlay.textContent = 'üîí';
                cell.appendChild(overlay);
            }
        }
        
        function checkSystemState() {
            if (!multiUserService || !isInitialized) return;
            
            // V√©rifier l'√©tat des cellules
            TEST_COLLABORATEURS.forEach(collab => {
                const cellId = `${collab}_${TEST_DATE}`;
                updateCellDisplay(cellId);
            });
        }
        
        async function testHover() {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©');
                return;
            }
            
            const testCellId = `${TEST_COLLABORATEURS[0]}_${TEST_DATE}`;
            log(`üß™ Test survol automatique sur: ${testCellId}`);
            
            await startHover(testCellId);
            setTimeout(async () => {
                await stopHover(testCellId);
                log('üß™ Test survol termin√©');
            }, 3000);
        }
        
        async function testLock() {
            if (!multiUserService || !isInitialized) {
                log('‚ö†Ô∏è Syst√®me non initialis√©');
                return;
            }
            
            const testCellId = `${TEST_COLLABORATEURS[1]}_${TEST_DATE}`;
            log(`üß™ Test verrouillage automatique sur: ${testCellId}`);
            
            await toggleLock(testCellId);
            setTimeout(async () => {
                await toggleLock(testCellId);
                log('üß™ Test verrouillage termin√©');
            }, 5000);
        }
        
        async function cleanup() {
            if (multiUserService && isInitialized) {
                try {
                    await multiUserService.cleanup();
                    log('üßπ Nettoyage effectu√©');
                } catch (error) {
                    log(`‚ùå Erreur nettoyage: ${error.message}`);
                }
            }
            
            isInitialized = false;
            multiUserService = null;
            updateStatus();
            
            // Reset cells
            document.querySelectorAll('.test-cell').forEach(cell => {
                cell.className = 'test-cell';
                cell.querySelectorAll('.cell-hover-indicator, .cell-lock-overlay').forEach(el => el.remove());
            });
            
            log('üîÑ Syst√®me r√©initialis√©');
        }
        
        function clearLog() {
            document.getElementById('log-output').textContent = 'üìù Logs du syst√®me...\n';
        }
        
        // Exposer les fonctions globalement pour les boutons
        window.initSystem = initSystem;
        window.testHover = testHover;
        window.testLock = testLock;
        window.cleanup = cleanup;
        window.clearLog = clearLog;
        
        // Initialisation
        updateStatus();
        generateTestCells();
        log('üí° Page de test charg√©e - Pr√™t √† tester le syst√®me r√©el');
        log('‚ö†Ô∏è IMPORTANT: Plus de fausses donn√©es Alice/Bob dans le syst√®me');
    </script>
</body>
</html>
