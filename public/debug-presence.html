<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Présence - Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .log { margin: 5px 0; padding: 5px; background: #2a2a2a; border-radius: 3px; }
        .session { border-left: 3px solid #4CAF50; padding-left: 10px; margin: 10px 0; }
        .expired { border-left-color: #f44336; }
        .active { border-left-color: #2196F3; }
        button { margin: 10px; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #45a049; }
        #output { max-height: 500px; overflow-y: auto; border: 1px solid #444; padding: 10px; }
        .timestamp { color: #888; font-size: 0.8em; }
        .session-info { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>🔍 Diagnostic Présence Firebase</h1>
    
    <div>
        <button onclick="startDiagnostic()">🚀 Démarrer le diagnostic</button>
        <button onclick="clearLogs()">🧹 Effacer les logs</button>
        <button onclick="createTestSession()">➕ Créer session test</button>
    </div>
    
    <div id="output"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js'
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            doc, 
            setDoc, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js'

        const firebaseConfig = {
            apiKey: "AIzaSyCq3SOeCYJrYb47GJIFKzuZE8Y8Qq7Ew7c",
            authDomain: "keydispo-1b7e7.firebaseapp.com",
            projectId: "keydispo-1b7e7",
            storageBucket: "keydispo-1b7e7.firebasestorage.app",
            messagingSenderId: "542090648726",
            appId: "1:542090648726:web:db9be1c3bcd01b69d72a85"
        }

        const app = initializeApp(firebaseConfig)
        const db = getFirestore(app)
        
        let diagnosticRunning = false
        let presenceListener = null

        window.startDiagnostic = function() {
            if (diagnosticRunning) {
                log('⚠️ Diagnostic déjà en cours')
                return
            }
            
            diagnosticRunning = true
            log('🚀 Démarrage du diagnostic temps réel...')
            
            // Écouter les changements en temps réel
            presenceListener = onSnapshot(collection(db, 'presence'), (snapshot) => {
                const now = new Date()
                const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000)
                
                log(`\n🔍 === Snapshot reçu: ${snapshot.docs.length} documents ===`)
                log(`⏰ Temps actuel: ${now.toISOString()}`)
                log(`⏰ Seuil d'expiration: ${fiveMinutesAgo.toISOString()}`)
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data()
                    
                    // Analyse du timestamp
                    let lastSeen = null
                    let lastSeenSource = 'unknown'
                    let timestampInfo = ''
                    
                    if (data.lastSeen) {
                        if (typeof data.lastSeen.toDate === 'function') {
                            lastSeen = data.lastSeen.toDate()
                            lastSeenSource = 'Firestore Timestamp'
                            timestampInfo = `seconds: ${data.lastSeen.seconds}, nanoseconds: ${data.lastSeen.nanoseconds}`
                        } else if (data.lastSeen instanceof Date) {
                            lastSeen = data.lastSeen
                            lastSeenSource = 'Date object'
                        } else if (typeof data.lastSeen === 'number') {
                            lastSeen = new Date(data.lastSeen)
                            lastSeenSource = 'Numeric timestamp'
                        } else {
                            timestampInfo = `Type: ${typeof data.lastSeen}, Value: ${JSON.stringify(data.lastSeen)}`
                        }
                    }
                    
                    const timeDiff = lastSeen ? now.getTime() - lastSeen.getTime() : 'N/A'
                    const isActive = lastSeen && lastSeen > fiveMinutesAgo
                    
                    const sessionDiv = document.createElement('div')
                    sessionDiv.className = `session ${isActive ? 'active' : 'expired'}`
                    sessionDiv.innerHTML = `
                        <div class="session-info">
                            <div><strong>👤 ${data.displayName || 'N/A'}</strong></div>
                            <div>📧 ${data.email || 'N/A'}</div>
                            <div>🆔 ${data.sessionId?.slice(-8) || 'N/A'}</div>
                            <div>📊 ${data.status || 'N/A'}</div>
                        </div>
                        <div class="timestamp">
                            🕒 LastSeen: ${lastSeen?.toISOString() || 'N/A'} (${lastSeenSource})
                            ${timestampInfo ? `<br>📋 ${timestampInfo}` : ''}
                            <br>⏱️ Age: ${typeof timeDiff === 'number' ? Math.round(timeDiff / 1000) : timeDiff}s
                            <br>✅ Status: ${isActive ? '🟢 ACTIVE' : '🔴 EXPIRED'}
                        </div>
                    `
                    
                    document.getElementById('output').appendChild(sessionDiv)
                })
                
                log(`📊 Résumé: ${snapshot.docs.length} total, ${snapshot.docs.filter(doc => {
                    const data = doc.data()
                    let lastSeen = null
                    if (data.lastSeen?.toDate) lastSeen = data.lastSeen.toDate()
                    else if (data.lastSeen instanceof Date) lastSeen = data.lastSeen
                    else if (typeof data.lastSeen === 'number') lastSeen = new Date(data.lastSeen)
                    return lastSeen && lastSeen > fiveMinutesAgo
                }).length} actives`)
            })
        }
        
        window.createTestSession = async function() {
            const sessionId = `test_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`
            const testData = {
                uid: `test-user-${Date.now()}`,
                sessionId: sessionId,
                email: `test-${Date.now()}@debug.com`,
                displayName: `Test User ${sessionId.slice(-6)}`,
                status: 'online',
                lastSeen: serverTimestamp()
            }
            
            try {
                await setDoc(doc(db, 'presence', testData.uid), testData)
                log(`✅ Session test créée: ${testData.displayName}`)
            } catch (error) {
                log(`❌ Erreur création session: ${error.message}`)
            }
        }
        
        window.clearLogs = function() {
            document.getElementById('output').innerHTML = ''
        }
        
        function log(message) {
            const output = document.getElementById('output')
            const div = document.createElement('div')
            div.className = 'log'
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`
            output.appendChild(div)
            output.scrollTop = output.scrollHeight
        }
    </script>
</body>
</html>
