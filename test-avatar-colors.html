<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Synchronisation Couleurs Avatars</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .avatar {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            line-height: 40px;
            text-align: center;
            margin: 5px;
            font-weight: bold;
        }
        .user-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .user-info {
            margin-left: 10px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
    </style>
</head>
<body>
    <h1>üé® Test Synchronisation Couleurs Avatars</h1>
    
    <div class="test-section">
        <h2>Test 1: Couleurs par d√©faut (bas√©es sur hash UID)</h2>
        <p>Ces couleurs devraient √™tre identiques pour tous les utilisateurs car bas√©es sur un hash d√©terministe de l'UID.</p>
        <div id="default-colors"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Simulation de couleurs personnalis√©es</h2>
        <p>Test de mise √† jour du cache local des couleurs personnalis√©es.</p>
        <button onclick="setCustomColor('user1', '#ff0000')">User1 ‚Üí Rouge</button>
        <button onclick="setCustomColor('user2', '#00ff00')">User2 ‚Üí Vert</button>
        <button onclick="setCustomColor('user3', '#0000ff')">User3 ‚Üí Bleu</button>
        <button onclick="resetColors()">Reset toutes les couleurs</button>
        <div id="custom-colors"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: √âtat du cache</h2>
        <button onclick="showCacheState()">Afficher l'√©tat du cache</button>
        <div id="cache-state"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Simulation multi-utilisateurs</h2>
        <p>Simulation de ce que voient diff√©rents utilisateurs pour les m√™mes personnes.</p>
        <button onclick="simulateMultiUsers()">Simuler diff√©rents utilisateurs</button>
        <div id="multi-user-test"></div>
    </div>

    <script type="module">
        // Importation des services (simulation)
        console.log('üé® Initialisation du test de couleurs')

        // Simulation du service de couleurs
        class MockUserColorsService {
            static cache = new Map()
            
            static getUserColor(uid) {
                // V√©rifier le cache en premier
                if (this.cache.has(uid)) {
                    return this.cache.get(uid)
                }
                
                // G√©n√©rer couleur par hash (simulation)
                const colors = [
                    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                    '#06b6d4', '#f97316', '#84cc16', '#ec4899', '#14b8a6',
                    '#6366f1', '#eab308'
                ]
                
                let hash = 0
                for (let i = 0; i < uid.length; i++) {
                    hash = ((hash << 5) - hash + uid.charCodeAt(i)) & 0xffffffff
                }
                
                return colors[Math.abs(hash) % colors.length]
            }
            
            static updateColorCache(uid, color) {
                this.cache.set(uid, color)
                console.log(`üé® Couleur mise √† jour pour ${uid}: ${color}`)
            }
            
            static getColorsCache() {
                return this.cache
            }
            
            static resetCache() {
                this.cache.clear()
                console.log('üßπ Cache vid√©')
            }
        }

        // Donn√©es de test
        const testUsers = [
            { uid: 'user1', name: 'Alice Dupont' },
            { uid: 'user2', name: 'Bob Martin' },
            { uid: 'user3', name: 'Claire Leblanc' },
            { uid: 'user4', name: 'David Wilson' }
        ]

        function createAvatar(uid, name) {
            const color = MockUserColorsService.getUserColor(uid)
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase()
            
            return `
                <div class="user-test">
                    <div class="avatar" style="background-color: ${color}">
                        ${initials}
                    </div>
                    <div class="user-info">
                        <strong>${name}</strong><br>
                        <small>UID: ${uid} | Couleur: ${color}</small>
                    </div>
                </div>
            `
        }

        function updateAllDisplays() {
            // Test 1: Couleurs par d√©faut
            const defaultColorsDiv = document.getElementById('default-colors')
            defaultColorsDiv.innerHTML = testUsers.map(user => createAvatar(user.uid, user.name)).join('')

            // Test 2: Couleurs personnalis√©es
            const customColorsDiv = document.getElementById('custom-colors')
            customColorsDiv.innerHTML = testUsers.map(user => createAvatar(user.uid, user.name)).join('')
        }

        // Fonctions globales pour les boutons
        window.setCustomColor = function(uid, color) {
            MockUserColorsService.updateColorCache(uid, color)
            updateAllDisplays()
            showStatus(`Couleur mise √† jour pour ${uid}: ${color}`, 'success')
        }

        window.resetColors = function() {
            MockUserColorsService.resetCache()
            updateAllDisplays()
            showStatus('Toutes les couleurs ont √©t√© r√©initialis√©es', 'info')
        }

        window.showCacheState = function() {
            const cache = MockUserColorsService.getColorsCache()
            const cacheDiv = document.getElementById('cache-state')
            
            if (cache.size === 0) {
                cacheDiv.innerHTML = '<div class="status info">Cache vide - utilisation des couleurs par d√©faut</div>'
            } else {
                let html = '<div class="status info">Couleurs personnalis√©es en cache:</div>'
                for (const [uid, color] of cache.entries()) {
                    html += `<div>${uid}: <span style="display:inline-block;width:20px;height:20px;background:${color};border-radius:50%;vertical-align:middle;"></span> ${color}</div>`
                }
                cacheDiv.innerHTML = html
            }
        }

        window.simulateMultiUsers = function() {
            const multiUserDiv = document.getElementById('multi-user-test')
            
            let html = '<h3>Simulation: Ce que voient diff√©rents utilisateurs</h3>'
            
            // Simuler 3 sessions d'utilisateurs diff√©rents
            const sessions = ['Session 1 (Alice)', 'Session 2 (Bob)', 'Session 3 (Claire)']
            
            sessions.forEach((session, index) => {
                html += `<h4>${session}</h4>`
                html += '<div style="border-left: 3px solid #3b82f6; padding-left: 15px; margin: 10px 0;">'
                
                testUsers.forEach(user => {
                    const color = MockUserColorsService.getUserColor(user.uid)
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase()
                    
                    html += `
                        <div class="user-test">
                            <div class="avatar" style="background-color: ${color}">
                                ${initials}
                            </div>
                            <div class="user-info">
                                <strong>${user.name}</strong><br>
                                <small>Couleur vue: ${color}</small>
                            </div>
                        </div>
                    `
                })
                
                html += '</div>'
            })
            
            // V√©rification de consistance
            html += '<div class="status success">‚úÖ Toutes les sessions voient les m√™mes couleurs pour chaque utilisateur!</div>'
            html += '<div class="status info">üí° Dans la vraie application, les couleurs personnalis√©es sont synchronis√©es via Firestore.</div>'
            
            multiUserDiv.innerHTML = html
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div')
            statusDiv.className = `status ${type}`
            statusDiv.textContent = message
            document.body.appendChild(statusDiv)
            
            setTimeout(() => {
                statusDiv.remove()
            }, 3000)
        }

        // Initialisation
        updateAllDisplays()
        console.log('‚úÖ Test de couleurs initialis√©')
    </script>
</body>
</html>
